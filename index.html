<!DOCTYPE html>
<html>

<head>
  <script src="jsPsych/jspsych.js"></script>
  <script src="jsPsych/plugins/jspsych-serial-reaction-time-mouse.js"></script>
  <script src="jsPsych/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jsPsych/plugins/jspsych-html-button-response.js"></script>
  <script src="jsPsych/plugins/jspsych-survey-text.js"></script>
  <script src="jsPsych/plugins/jspsych-call-function.js"></script>
  <script src="js/serverComm.js"></script>
  <link rel="stylesheet" href="jsPsych/css/jspsych.css"></link>
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #jspsych-target {
      width: 100%;
      height: 100%;
    }

    #srt-score {
      position: absolute;
      width: 100%;
      border-bottom: 1px solid #ddd;
      background-color: #fafafa;
      margin: 0;
      text-align: center;
      display: none;
    }

    #srt-score progress {
      width: 500px;
    }

    #srt-score .srt-top {
      padding: 10px 75px;
      display: inline-block;
      font-family: 'Open Sans', 'Arial';
      font-size: 16px;
      color: #333;
    }
  </style>
</head>

<body>
  <div id="srt-score">
    <span class="srt-top">Correct responses: <span id="srt-correct-count">0</span></span>
    <span class="srt-top">Time: <progress max="100" value="0" id="srt-timer"></progress></span>
  </div>
  <div id="jspsych-target"></div>
</body>
<script>
  // experiment parameters
  var break_after_each_square = 200;
  var break_before_block = 500;
  var block_length = 90000; // milliseconds
  var n_blocks = 1;
  var condition = 1;//jsPsych.randomization.sample([1,2,3],1);
  var n_pairs;
  var order_array;

  // experiment grid
  var grid_rows = 6;
  var grid_cols = 6;
  var square_size = 50;

  var grid = [];
  var locations = [];

  for (var i = 0; i < grid_rows; i++) {
    grid.push([]);
    for (var j = 0; j < grid_cols; j++) {
      grid[i].push(1);
      if (i > 0 && i < grid_rows - 1 && j > 0 && j < grid_cols - 1) {
        locations.push([i, j]);
      }
    }
  }

  // create experiment timeline
  var timeline = [];

  // consent, welcome
  var consent_form = {
    type: 'html-button-response',
    stimulus: "<p>This is a research project conducted at Vassar College. In this experiment, you will play a simple computer game in which you try to quickly click symbols that appear on your screen. Our experiment investigates how different factors related to this game change how quickly people play. The experiment will take approximately 15 minutes to complete. You will receive a payment of £2.00 (about $2.50) upon completion of the experiment. The data we collect during the experiment are not linked to potentially identifying information, including your account information on Prolific. These data will solely be used for research purposes. You are free to stop the experiment by closing your browser window at any time. If you have any questions, you can contact Dr. Joshua de Leeuw at jdeleeuw@vassar.edu.</p>" +
      "<p>By clicking “I agree”, you affirm that you are at least 18 years of age, which is the minimum age to participate in this study, and that you understand the nature of your participation in this research. If you do not wish to participate, please close this window.</p",
    choices: ['I agree.']
  }

  timeline.push(consent_form);

  var welcome_block = {
    type: "html-keyboard-response",
    stimulus: "Hi there! Welcome to the experiment. Press B to begin.",
    choices: ['b']
  }

  timeline.push(welcome_block);

  // instructions

  var instructions_general = {
	  type: "html-keyboard-response",
	  stimulus: "<p>This experiment involves playing a simple game. You'll see a grid of squares that change into various colors, and your job is to click on each square when it changes. For instance, for the following grid:</p>" +
      jsPsych.plugins['serial-reaction-time-mouse'].stimulus([[1,1],[1,1]], 80, [0,1], '#FF0000') +
		  "<p>You would click on the red square.</p>" +
		  "<p>The goal of the game is to click on as many squares as you can within the time limit.</p>" +
		  "<p>Press spacebar to continue when you are ready.</p>",
	  choices: ['spacebar']
  }
  timeline.push(instructions_general);

  var instructions_practice = {
	  type: "html-keyboard-response",
	  stimulus: "<p><b>Practice:</b></p>" +
  	  "<p>Here's a quick practice round to get you used to the game. You will see four squares like these: </p>" +
  	  jsPsych.plugins['serial-reaction-time-mouse'].stimulus([[1,1],[1,1]], 80) +
  	  "<p>Press spacebar to begin when you are ready.</p>",
	  choices: ['spacebar']
  }
  timeline.push(instructions_practice);

  var practice_timeline = {
  	timeline: [
      {
        type: 'serial-reaction-time-mouse',
        grid_square_size: 80,
        target: jsPsych.timelineVariable('target'),
        grid: [[1,1],[1,1]],
        target_color: function(){ return jsPsych.randomization.shuffle(["#f3c300", "#875692", "#f38400", "#a1caf1", "#be0032", "#c2b280", "#848482", "#008856"])[0]; },
        timing_pre_target: break_after_each_square,
      }
    ],
    randomize_order: true,
    repetitions: 3,
    timeline_variables: [
      {target: [0,0]},
      {target: [0,1]},
      {target: [1,0]},
      {target: [1,1]}
    ]
  }
  timeline.push(practice_timeline);

  // show timer
  var show_timer = {
    type: 'call-function',
    func: function() {
      document.querySelector('#srt-score').style.display = 'block';
    }
  }
  timeline.push(show_timer);

  // test blocks
  var block_start_time;
  var which_target;
  var data_predictable;
  var timer_ticks;
  var count_correct;
  var high_score = 0;
  var last_predictor = null;
  var last_target = null;
  var colors = ["#f3c300", "#875692", "#f38400", "#a1caf1", "#be0032", "#c2b280", "#848482", "#008856"];
  var deltas = [
    [-1, -1],
    [-1, 0],
    [-1, 1],
    [0, -1],
    [0, 1],
    [1, -1],
    [1, 0],
    [1, 1]
  ];
  if(condition == 1){
    n_pairs = 4;
    order_array = [0,1,2,3];
  } else if (condition == 2) {
    n_pairs = 6;
    order_array = [0,1,2,3,4,5];
  }
  else if (condition == 3) {
    n_pairs = 8;
    order_array = [0,1,2,3,4,5,6,7];
  }

  var deltas = jsPsych.randomization.sampleWithoutReplacement(deltas, n_pairs);
  var order = jsPsych.randomization.shuffle(order_array);
  var current_idx = 0;

  function getNextPredictor() {
    var predictor = jsPsych.randomization.sampleWithoutReplacement(locations, 1)[0];
    if (last_target !== null) {
      while (predictor[0] == last_target[0] && predictor[1] == last_target[1]) {
        predictor = jsPsych.randomization.sampleWithoutReplacement(locations, 1)[0];
      }
    }
    last_predictor = predictor;
    return predictor;
  }

  function getNextTarget() {
    var target = last_predictor.slice();
    var d = deltas[order[current_idx]];
    target[0] = target[0] + d[0];
    target[1] = target[1] + d[1];
    last_target = target;
    return target;
  }

  function getColor() {
    return colors[order[current_idx]];
  }

  for (var i = 0; i < n_blocks; i++) {

    var timer_start = {
      type: 'call-function',
      func: function() {
        order = jsPsych.randomization.shuffle(order);
        current_idx = 0;
        last_target = null;
        last_predictor = null;
        data_predictable = 'unpredictable';
        count_correct = 0;
        document.querySelector('#srt-correct-count').innerHTML = count_correct;
        block_start_time = Date.now();
        timer_ticks = setInterval(function() {
          var proportion_time_elapsed = Math.floor((Date.now() - block_start_time) / block_length * 100);
          document.querySelector('#srt-timer').value = proportion_time_elapsed;
        }, 100)
      }
    }
    timeline.push(timer_start);

    var test = {
      data: {block: i},
      timeline: [{
        type: 'serial-reaction-time-mouse',
        grid: grid,
        target: function(){
          var next;
          if(data_predictable == 'unpredictable'){
            next = getNextPredictor();
          } else {
            next = getNextTarget();
          }
          return next;
        },
        target_color: getColor,
        grid_square_size: square_size,
        on_finish: function(data){
          data.pair = order[current_idx];
          data.direction = JSON.stringify(deltas[data.pair]);
          if(Math.abs(data.direction[0])!==Math.abs(data.direction[1]) && data_predictable == 'predictable'){
            data.cardinal = true;
          } else {
            data.cardinal = false;
          }
          data.target_type = data_predictable;
          count_correct++;
          document.querySelector('#srt-correct-count').innerHTML = count_correct;
          if(data_predictable == 'predictable'){
            current_idx++;
            if (current_idx >= order.length) {
              order = jsPsych.randomization.shuffle(order);
              current_idx = 0;
            }
          }
          data_predictable = (data_predictable == 'predictable') ? 'unpredictable' : 'predictable';
        }
      }],
      loop_function: function() {
        if (Date.now() - block_start_time < block_length) {
          return true;
        } else {
          return false;
        }
      }
    }
    timeline.push(test);

    var feedback = {
      type: 'html-keyboard-response',
      choices: ['spacebar'],
      stimulus: function(){
        clearInterval(timer_ticks);
        var which_block = jsPsych.data.get().last(1).values()[0].block;
        var data = jsPsych.data.get().filter({block: which_block});
        var count = data.filter({correct: true}).count();
        var msg = "<p>You clicked on <b>"+count+" blocks</b> that round.</p>";
        if(which_block === 0){
          msg += "<p>That's a good start. See if you can get more next round.</p>";
          msg += "<p>There are " + (n_blocks - 1 - which_block) + " rounds remaining in the experiment.</p>";
          high_score = count;
          msg += "<p>Take a break if you need to, and press <b>spacebar</b> to continue when you are ready.</p>";
        } else if(which_block !== (n_blocks - 1)) {
          if(count >= high_score){
            msg += "<p>That's your best score yet!</p>";
            if((n_blocks - 1 - which_block) == 1){
              msg += "<p>The next round will be the final round in the experiment.</p>";
            } else {
              msg += "<p>There are " + (n_blocks - 1 - which_block) + " rounds remaining in the experiment.</p>";
            }
            high_score = count;
          } else {
            msg += "<p>That's <b>"+(high_score-count)+ "</b> away from your best round.</p>";
          }
          msg += "<p>Take a break if you need to, and press <b>spacebar</b> to continue when you are ready.</p>";
        } else {
          if(count >= high_score){
            msg += "<p>That's your best score yet!</p>";
            high_score = count;
          } else {
            msg += "<p>That's <b>"+(high_score-count)+ "</b> away from your best round.</p>";
          }
          msg += "<p>Nice job, that was the last round!</p>";
          msg += "<p>Press <b>spacebar</b> to continue.</p>";
        }
        return msg;
      },
      timing_post_trial: break_before_block
    }
    timeline.push(feedback);
  }

  // explicit knowledge check
  var ek_instructions = {
    type: 'html-keyboard-response',
    stimulus: '<p>This final part of the experiment involves just a few questions.</p>'+
      '<p>During the previous rounds, you may have noticed that two squares in a row always appeared in the same color. You may have also noticed that colors provided information about where the next square to click on would appear. '+
      'We are interested in whether you noticed and remember these patterns.</p>'+
      '<p>On the next several screens, you will see a grid and single colored square like you saw in the previous rounds. This time, please click '+
      'on the square where you think the next square of the same color would appear, assuming that the square being displayed is the first in the sequence of two.</p>'+
      '<p>Press B to begin.</p>',
    choices: ['b']
  }
  timeline.push(ek_instructions);

  // debrief
  var test_patterns_text = {
    type: 'html-keyboard-response',
    stimulus: "<p>You may have noticed that colors of the squares in the sequence were paired—there were always two of a color in a row. So if you see a red square the next square will also be red.</p>"+
    "<p>The next few questions do not have a time limit. We will show you a grid with the center square highlighted a color, in the grid below the position of the highlighted square is filled black.</p>"+
    jsPsych.plugins['serial-reaction-time-mouse'].stimulus(locations,square_size) +
    "<p>You will be asked to click where the next highlighted square will appear.</p>"+
    "<p>Press the spacebar to continue.",
    choices: ['spacebar']
  }
  timeline.push(test_patterns_text);

  jsPsych.init({
    display_element: 'jspsych-target',
    timeline: timeline
  });
</script>

</html>
